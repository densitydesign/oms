<div class="container-fluid side-all">
	<div class="row side-all">
		<div class="col-md-3 col-sm-12 side-panel">
			<div class="row side-all">
				<div class="col-md-12 col-sm-9 col-xs-9 adva-cont">
					<div class="adv-step step1" style="display:block;">

						<h3>crawiling network graph</h3>
						<h2>Visualizing the Clusters - 1</h2>
						<hr>
						<p>
							Nevertheless, upon Stubb setting the anchor-watch after his supper was concluded; and when, accordingly, Queequeg and a forecastle seaman came on deck, no small excitement was created among the sharks; for immediately suspending the cutting stages over the side, and lowering three lanterns, so that they cast long gleams of light over the turbid sea, these two mariners, darting their long whaling-spades, kept up an incessant murdering.
						</p>

					</div>

					<div class="adv-step step2">

						<h3>crawiling network graph</h3>
						<h2>Visualizing the Clusters - 2</h2>
						<hr>
						<p>
							Nevertheless, upon Stubb setting the anchor-watch after his supper was concluded; and when, accordingly, Queequeg and a forecastle seaman came on deck, no small excitement was created among the sharks; for immediately suspending the cutting stages over the side, and lowering three lanterns, so that they cast long gleams of light over the turbid sea, these two mariners, darting their long whaling-spades, kept up an incessant murdering.
						</p>

					</div>

					<div class="adv-step step3">

						<h3>crawiling network graph</h3>
						<h2>Visualizing the Clusters - 3</h2>
						<hr>
						<p>
							Nevertheless, upon Stubb setting the anchor-watch after his supper was concluded; and when, accordingly, Queequeg and a forecastle seaman came on deck, no small excitement was created among the sharks; for immediately suspending the cutting stages over the side, and lowering three lanterns, so that they cast long gleams of light over the turbid sea, these two mariners, darting their long whaling-spades, kept up an incessant murdering.
						</p>

					</div>

					<div class="adv-step step4">

						<h3>crawiling network graph</h3>
						<h2>Visualizing the Clusters - 4</h2>
						<hr>
						<p>
							Nevertheless, upon Stubb setting the anchor-watch after his supper was concluded; and when, accordingly, Queequeg and a forecastle seaman came on deck, no small excitement was created among the sharks; for immediately suspending the cutting stages over the side, and lowering three lanterns, so that they cast long gleams of light over the turbid sea, these two mariners, darting their long whaling-spades, kept up an incessant murdering.
						</p>

					</div>

					<div class="adv-step step5">

						<h3>crawiling network graph</h3>
						<h2>Visualizing the Clusters - 5</h2>
						<hr>
						<p>
							Nevertheless, upon Stubb setting the anchor-watch after his supper was concluded; and when, accordingly, Queequeg and a forecastle seaman came on deck, no small excitement was created among the sharks; for immediately suspending the cutting stages over the side, and lowering three lanterns, so that they cast long gleams of light over the turbid sea, these two mariners, darting their long whaling-spades, kept up an incessant murdering.
						</p>

					</div>

					<div class="adv-step step6">

						<h3>crawiling network graph</h3>
						<h2>Visualizing the Clusters - 6</h2>
						<hr>
						<p>
							Nevertheless, upon Stubb setting the anchor-watch after his supper was concluded; and when, accordingly, Queequeg and a forecastle seaman came on deck, no small excitement was created among the sharks; for immediately suspending the cutting stages over the side, and lowering three lanterns, so that they cast long gleams of light over the turbid sea, these two mariners, darting their long whaling-spades, kept up an incessant murdering.
						</p>

					</div>

					<div class="adv-step step7">

						<h3>crawiling network graph</h3>
						<h2>Try it yourself</h2>
						<hr>
						<div class="btn-container" id="custom">
							<h4>Show </h4>
							<div class="btn-group show-lvl">
								<button id="language" type="button" class="btn btn-default">
									Language
								</button>
								<button id="forum" type="button" class="btn btn-default">
									Forum
								</button>
								<button id="post" type="button" class="btn btn-default pressed">
									Post
								</button>

							</div>

						</div>

						<div class="btn-container" id="custom">
							<h4>Sort by</h4>
							<div class="btn-group sort-by">
								<button id ="by-replies" type="button" class="btn btn-default">
									Replies
								</button>

								<button id ="by-time" type="button" class="btn btn-default">
									Time
								</button>

								<button id ="by-author" type="button" class="btn btn-default pressed">
									Authors
								</button>

							</div>

						</div>
					</div>

				</div>

				<div class="col-md-12 col-sm-3 col-xs-3 legend">
					<h3>key</h3>
					<p>
						Blue is good
						<br/>
						Red is bad
					</p>
				</div>
			</div>
		</div>
		<div class="col-md-9 col-sm-12 main-viz"></div>
	</div>
</div>

<div id="protocol">

	<div class="proto-title closing">
		PROTOCOL_01 <img class="close-btn" src="img/cross.png"/>
	</div>

</div>

<style>
	rect {
		stroke: none;
	}

	form {
		position: absolute;
		left: 30px;
		top: 10px;
	}

	section {
		height: 100%;
	}

	.main-viz {
		padding-top: 80px;
	}

</style>

<script>
	console.log("loaded")
	var data, treemap, cell, rects, node, x, y, root, n

	var dsv_egg = d3.dsv(";", "text/plain");

	dsv_egg("data/threads.csv", function(d) {
		return {
			lang : d.lang,
			forum : d.forum,
			title : d.title,
			orig_author : d.original_author,
			time : +d.time,
			nb_authors : +d.nb_authors,
			nb_replies : +d.nb_replies,
			post_length : +d.avg_post_length
		};
	}, function(error, rows) {

		//COMMENT EN
		rows = rows.filter(function(row) {
			if (row.lang == "en")
				return false;
			else
				return true;
		});

		data = d3.nest().key(function(d) {
			return d.lang;
		}).key(function(d) {
			return d.forum;
		}).entries(rows);

		viz();
	});

	var margin = {
		top : 10,
		right : 10,
		bottom : 10,
		left : 10
	}, width = window.outerWidth * 0.7 - margin.left - margin.right, height = window.outerHeight * 0.8 - margin.top - margin.bottom;

	var txtScale = d3.scale.linear().domain([1, 4]).range([1, 0.4])
	x = d3.scale.linear().range([0, width / 2])
	y = d3.scale.linear().range([0, height / 2])

	var color = d3.scale.ordinal().range(["#D5C23A", "#E83931", "#83A493", "#415762", "#351D11"]);

	var treemap = d3.layout.treemap().size([width, height]).sticky(true).padding(function(d) {
		return 8 - (d.depth * 2)
	}).children(function(d) {
		return d.values;
	}).value(function(d) {
		return 1
	});

	var div = d3.select(".main-viz").append("svg").attr("width", (width + margin.left + margin.right)).attr("height", (height + margin.top + margin.bottom))
	var tt = d3.select("body").append("div").attr("class", "tooltip").style("opacity", 0);

	function viz() {

		data = {
			"key" : "data",
			"values" : data
		}
		n = root = data;
		console.log(n);

		node = div.datum(data).selectAll(".node").data(treemap.nodes).enter().append("rect").attr("class", "node").call(position).style("fill", function(d) {
			if (!d.depth > 1)
				return "#83A493";
			else if (d.depth > 0)
				return d.lang == 'it' || d.key == 'it' || d.parent.key == 'it' ? "#83A493" : '#D6C33B';
			else
				return "none"
		}).style("opacity", 1).on("click", function(d) {
			console.log(d)
		}).attr("class", function(d) {
			return "lvl-" + d.depth
		}).on('click', function(d) {
			if (l == d.depth) {
				
					drawTt(d);
					
				
			}
		})
		//.text(function(d) { return d.children ? null : d.depth; });

		createText(1);

		d3.selectAll("input").on("change", function change() {
			var value = this.value === "count" ? function(d) {
				return d.nb_authors;
			} : function(d) {
				return 1.00;
			};

			node.data(treemap.value(value).nodes).transition().duration(500).call(position);

			d3.selectAll(".text").transition().duration(500).attr("x", function(d) {
				return d.x
			}).attr("y", function(d) {
				return d.y
			})
		});
	};
	
	function drawTt(d) {
		
		tt.style("opacity", 1);
		if(d.depth==1) {
			tt.html('<div class="tt"><div><b>Site language:</b> '+d.key+'</div><div><b>Forum count:</b> '+d.values.length+'</div></div>').style("left", (d3.event.pageX) + "px").style("top", (d3.event.pageY - 28) + "px");
		}
		else if(d.depth==2) {
			tt.html('<div class="tt"><div><b>Forum title:</b> '+d.key+'</div><div><b>Post count:</b> '+d.values.length+'</div></div>').style("left", (d3.event.pageX) + "px").style("top", (d3.event.pageY - 28) + "px");
		}
		else if(d.depth==3) {
			tt.html('<div class="tt"><div><b>Author: </b>'+d.orig_author+'</div><div><b>Post title:</b> '+d.title+'</div><div><b>Forum:</b> '+d.forum+'</div></div>').style("left", (d3.event.pageX) + "px").style("top", (d3.event.pageY - 28) + "px");
		}
	}
	
	function position() {
		this.attr("x", function(d) {
			return d.x;
		}).attr("y", function(d) {
			return d.y;
		}).attr("width", function(d) {
			return Math.max(0, d.dx - 1);
		}).attr("height", function(d) {
			return Math.max(0, d.dy - 1);
		});
	}

	function step1() {
		node.transition().duration(500).style("opacity", 1)
		createText(1);
		setLvl(1)
	}

	function step2() {

		console.log("2")
		node.transition().duration(500).style("opacity", function(d) {
			if (d.depth > 1)
				return 1;
			else
				return 0
		})
		createText(2);
		setLvl(2)
	}

	function step3() {

		node.data(treemap.value(function(d) {
			return 1;
		}).nodes).transition().duration(500).call(position).style("opacity", function(d) {
			if (d.depth < 3)
				return 0;
			else
				return 1
		
		});
		setLvl(3)
		d3.selectAll(".text").remove();
	}

	function step4() {

		val = function(d) {
			return d.nb_replies;
		}

		node.data(treemap.value(val).nodes).transition().duration(500).call(position).style("opacity", function(d) {
			if (d.depth < 3)
				return 0;
			else
				return 1
		});
		setLvl(3)
		d3.selectAll(".text").remove();

	}

	function step5() {

		node.data(treemap.value(function(d) {
			return d.time;
		}).nodes).transition().duration(500).call(position).style("opacity", function(d) {
			if (d.depth < 3)
				return 0;
			else
				return 1
		});
		setLvl(3)
		d3.selectAll(".text").remove();
	}

	function step6() {

		console.log("6")
		node.data(treemap.value(function(d) {
			return d.nb_authors;
		}).nodes).transition().duration(500).call(position).style("opacity", function(d) {
			if (d.depth < 3)
				return 0;
			else
				return 1
		})
		setLvl(3)
		d3.selectAll(".text").remove();
	}

	function step7() {
		step6()
		
	}

	function setLvl(n) {
		tt.style("opacity", 0);
		l = n;
		for ( i = 0; i < 4; i++) {
			if (i != n)
				$(".lvl-" + i).css("pointer-events", "none");
		}
		$(".lvl-" + n).css("pointer-events", "auto");
	}

	function createText(lvl) {

		d3.selectAll(".text").remove();

		div.selectAll(".text").data(treemap.nodes).enter().append("text").filter(function(d) {
			if (d.depth == lvl && d.dx > 100 && d.dy > 20)
				return true;
			else
				return false;
		}).attr("class", "text").attr("font-family", "sans-serif").attr("font-size", txtScale(lvl) + "em").attr("fill", "white").transition().duration(500).attr("opacity", 0.7).attr("x", function(d) {
			console.log(d);
			return d.x
		}).attr("y", function(d) {
			return d.y
		}).attr("dx", txtScale(lvl) * 0.7 + "em").attr("dy", txtScale(lvl) * 1.4 + "em").text(function(d) {
			return d.key
		});
	}

	// CONTROLS

	var l = 0;

	d3.select(window).on("resize", function() {
		d3.select("svg").attr("width", window.outerWidth * 0.7);
		d3.select("svg").attr("height", window.outerHeight * 0.8);
	});

	d3.select("#language").on('click', function() {
		d3.select(".show-lvl .pressed").classed("pressed", false)
		d3.select(this).classed("pressed", true)
		node.filter(function(d) {
			return d.depth == 1
		}).transition().duration(500).style("opacity", 1)
		setLvl(1)

		createText(1);
	})

	d3.select("#forum").on('click', function() {
		d3.select(".show-lvl .pressed").classed("pressed", false)
		d3.select(this).classed("pressed", true)
		node.filter(function(d) {
			return d.depth > 1
		}).transition().duration(500).style("opacity", 1)
		node.filter(function(d) {
			return d.depth <= 1
		}).transition().duration(500).style("opacity", 0)
		setLvl(2)

		createText(2);

	})
	d3.select("#post").on('click', function() {
		d3.select(".show-lvl .pressed").classed("pressed", false)
		d3.select(this).classed("pressed", true)
		d3.selectAll(".text").remove();
		setLvl(3)

		node.filter(function(d) {
			return d.depth <= 2
		}).transition().duration(500).style("opacity", 0)
	})

	d3.select("#by-replies").on("click", function() {
		d3.select(".sort-by .pressed").classed("pressed", false)
		d3.select(this).classed("pressed", true)
		val = function(d) {
			return d.nb_replies;
		}
		node.data(treemap.value(val).nodes).transition().duration(500).call(position)
		if (l > 0)
			createText(l);
		tt.style("opacity", 0);
	})

	d3.select("#by-time").on("click", function() {
		d3.select(".sort-by .pressed").classed("pressed", false)
		d3.select(this).classed("pressed", true)
		val = function(d) {
			return d.time;
		}
		node.data(treemap.value(val).nodes).transition().duration(500).call(position)
		if (l > 0)
			createText(l);
		tt.style("opacity", 0);
	})

	d3.select("#by-author").on("click", function() {
		d3.select(".sort-by .pressed").classed("pressed", false)
		d3.select(this).classed("pressed", true)
		val = function(d) {
			return d.nb_authors;
		}
		node.data(treemap.value(val).nodes).transition().duration(500).call(position)
		if (l > 0)
			createText(l);
		tt.style("opacity", 0);
	})

</script>

