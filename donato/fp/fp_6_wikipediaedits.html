<!DOCTYPE html>
<html>
<head>
	<script type="text/javascript" src="js/d3.v3.min.js"></script>
	<script src="https://code.jquery.com/jquery.js"></script>	
	<script type="text/javascript" src="js/oms/pack.js"></script>
	<link href='http://fonts.googleapis.com/css?family=Julius+Sans+One' rel='stylesheet' type='text/css'>
	<link href='http://fonts.googleapis.com/css?family=Asap' rel='stylesheet' type='text/css'>
	
	<title>WHO Caesarean Section - Google images analysis</title>
</head>

<style>


text {
  font: 10px sans-serif;
}

.sel {
	fill:#83A493 !important;
	-webkit-transition: fill .3s ease;
        -moz-transition: fill .3s ease;
        -o-transition: fill .3s ease;
        transition: fill .3s ease;
}

</style>
<body>

<script>
var data;
var langLvl=0;
var langScale,tagScale;
var dsv_egg = d3.dsv(";", "text/plain");

dsv_egg("data/CS_img.csv",function(d) {
  return {
  	keyword: d.keyword,
    image: d.image,
    lang: d.lang,
    rank: +d.rank
  };
}, 
	function(error, rows) {
	  
   		data = d3.nest()
   		.key(function(d) {return d.lang; })
        .key(function(d) {return d.keyword; })
        .entries(rows);
        
        maxH=0
        
	    data.forEach(function (d,i) {
	    	d.count=0;
			d.y=maxH
	    	d['values'].forEach(function(e,j) {
	    		maxH+=e['values'].length
	    		d.count+=e['values'].length
	    		
	    	});
	    });
	    
		viz();
		
		});
     
     var margin = {top: 40, right: 10, bottom: 10, left: 10},
    width = 1360 - margin.left - margin.right,
    height = 800 - margin.top - margin.bottom;
     
     
     var listW = width*0.2;
     
     var svg, langs, tags;
     svg = d3.select("body").append("svg")
    .attr("width", (width + margin.left + margin.right))
    .attr("height", (height + margin.top + margin.bottom))
    
    
     function viz() {
    
    //scale function 	
	langScale = d3.scale.linear().domain([0, maxH]);
	langScale.range([0, height]) 
	
	
	
	//draw lang rects
    langs = svg.selectAll(".lang").data(data)
    .enter()
    .append("rect")
    .attr("class", "lang")
	.attr("x",  20)
	.attr("y", function(d){return langScale(d.y)+2})
    .attr("width", listW)
	.attr("height", function(d) {return langScale(d.count) })
    .style("fill", function(d) {return "#dddddd";})
    .style("stroke","#999999")
    .on("click", function(d){
    	
    	//color current selection
    	d3.select(".lang.sel").classed("sel",false)
    	d3.select(this).classed("sel",true)
    	
    	//ealstify list
    	elastify(d)});
    
    //labels for languages 
    svg.selectAll(".lang-txt")
    .data(data)
    .enter()
    .append("text")
    .attr("class", "lang-txt")
    .attr("font-family", "serif")
	.attr("font-size", "1em")
	.attr("x",  20)
	.attr("y", function(d){return langScale(d.y)+2})
	.attr("dx", "0.4em")
	.attr("dy", "1.3em")
	.style("fill","#222222")
	.text(function(d){console.log(d);return d.key})
      
    }
     
     
     function elastify(d) {
     	
     	//compute height
     	tagH=0

     	d['values'].sort(function(a,b) {
     		return b['values'].length-a['values'].length
     		})
     	
     	d['values'].forEach(function(e,i){
     		
     		//e.y=tagH;
     		tagH+=e['values'].length	
     	})
     	
     	//rescale the scale 
     	
     	tagScale = d3.scale.linear().range([height/37, height/1.75]); 
     	tagScale.domain([0, tagH]).clamp(true)
     	
     	
     	vals=0
     	d['values'].forEach(function(e,i){
     		
     		e.y=vals;
     		e.h=tagScale(e['values'].length)
     		
     		vals+=e.h	
     	})
     	
     	
     	//draw section
     	//t=svg.append("g")
     	tags= svg.selectAll(".tag").data(d.values,function(e){return e.key})
     	
	    var enter = tags.enter()
	    .append("rect")
	    
	    //enter new elements
	    enter.attr("class","tag")
	    .attr("x",  40+listW)
		.attr("y", function(e){return e.y})
	    .attr("width", listW)
		.attr("height", function(e) {return e.h })
	    .style("fill", function(e) {return "#dddddd";})
	    .style("stroke","#999999")
	    .on("click", function(d){
    	
	    	//color current selection
	    	d3.select(".tag.sel").classed("sel",false)
	    	d3.select(this).classed("sel",true)
    	});
	    
	    //transition on existing
	    tags.transition().duration(500)
	    .attr("y", function(e){return e.y})
		.attr("height", function(e) {return e.h })
	    
	    //remove old elements
	    tags.exit().remove();
	    
	    //Text
	    txt = svg.selectAll(".tag-txt")
	    .data(d.values,function(e){return e.key})
	    
	    txtEnt=txt.enter()
	    .append("text")
	    
	    txtEnt
	    .attr("class", "tag-txt")
	    .attr("font-family", "serif")
		.attr("font-size", "1em")
		.attr("x",  40+listW)
		.attr("y", function(e){return e.y})
		.attr("dx", "0.4em")
		.attr("dy", "1.3em")
		.style("fill","#222222")
		.text(function(d){console.log(d);return d.key})
		
		txt.transition().duration(500)
		.attr("y", function(e){return e.y})
		
		txt.exit().remove()
		
	    
	    
	    
	    
     }

     
</script>


</body>
</html>